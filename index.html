<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>読み札データ作成ツール</title>
<style>
  /* スタイルは前回と同じ */
</style>
</head>
<body>
  <!-- ヘッダー部分は前回と同じ -->
  
  <h1>読み札データ作成ツール</h1>
  <p>かるたの読み札を改行して区切ってください</p>
  <textarea id="input" placeholder="例：&#13;りんご&#13;みかん&#13;バナナ"></textarea>
  <br />
  <button id="saveBtn">変換して保存</button>

  <script>
    function getDateFileName() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + 1;
      const d = now.getDate();
      const h = now.getHours();
      const min = now.getMinutes();
      const s = now.getSeconds();
      return `${y}${m}${d}${h}${min}${s}.yomifuda`;
    }

    document.getElementById('saveBtn').onclick = function () {
      const input = document.getElementById('input').value;
      const lines = input.split('\n').map(s => s.trim()).filter(s => s.length > 0);
      if (lines.length === 0) {
        alert('入力が空です');
        return;
      }
      const jsonStr = JSON.stringify(lines, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      // 新しいウィンドウでダウンロード処理
      const downloadWindow = window.open('', '_blank');
      if (downloadWindow) {
        downloadWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>ダウンロード中</title>
            <script>
              window.onload = function() {
                const a = document.createElement('a');
                a.href = '${url}';
                a.download = '${getDateFileName()}';
                document.body.appendChild(a);
                a.click();
                setTimeout(function() {
                  window.close();
                }, 1000);
              };
            </script>
          </head>
          <body>
            <p>ダウンロードを開始します...</p>
          </body>
          </html>
        `);
        downloadWindow.document.close();
      } else {
        alert('ポップアップがブロックされました。ブラウザ設定を確認してください');
      }
      
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    };
  </script>
</body>
</html>
